generator client {
    provider = "prisma-client"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "postgresql"
}

model User {
    id            String    @id
    name          String
    email         String
    emailVerified Boolean   @default(false)
    image         String?
    company       String?
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt
    sessions      Session[]
    accounts      Account[]

    members     Member[]
    invitations Invitation[]
    inviterInvitationLinks InvitationLink[] @relation("inviterInvitationLinks")
    joinerInvitationLinks   InvitationLink[] @relation("joinerInvitationLinks")

    updatesValidated Update[] @relation("validatedUpdates")

    @@unique([email])
    @@map("user")
}

model Session {
    id        String   @id
    expiresAt DateTime
    token     String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    ipAddress String?
    userAgent String?
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    activeOrganizationId String?

    @@unique([token])
    @@index([userId])
    @@map("session")
}

model Account {
    id                    String    @id
    accountId             String
    providerId            String
    userId                String
    user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    password              String?
    createdAt             DateTime  @default(now())
    updatedAt             DateTime  @updatedAt

    @@index([userId])
    @@map("account")
}

model Verification {
    id         String   @id
    identifier String
    value      String
    expiresAt  DateTime
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@index([identifier])
    @@map("verification")
}

model Organization {
    id          String    @id
    name        String
    slug        String
    logo        String?
    createdAt   DateTime
    metadata    String?
    deadline    DateTime?

    members     Member[]
    invitations Invitation[]
    invitationLinks InvitationLink[]
    updates     Update[]

    @@unique([slug])
    @@map("organization")
}

enum MemberRole {
    MAKER
    CLIENT
}

model Member {
    id             String       @id
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    userId         String
    user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    role           MemberRole   @default(CLIENT)
    createdAt      DateTime

    @@unique([userId, organizationId])
    @@index([organizationId])
    @@index([userId])
    @@map("member")
}

enum InvitationStatus {
    PENDING
    ACCEPTED
    EXPIRED
}

model Invitation {
    id             String       @id
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    email          String
    role           MemberRole   @default(CLIENT)
    status         InvitationStatus       @default(PENDING)
    expiresAt      DateTime
    createdAt      DateTime     @default(now())
    inviterId      String
    user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

    @@index([organizationId])
    @@index([email])
    @@map("invitation")
}

model InvitationLink {
    id             String       @id
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    role           MemberRole   @default(CLIENT)
    link           String       @unique

    inviterId      String
    user           User         @relation("inviterInvitationLinks", fields: [inviterId], references: [id], onDelete: Cascade)

    joinerId      String?
    joiner        User?        @relation("joinerInvitationLinks", fields: [joinerId], references: [id], onDelete: SetNull)

    status         InvitationStatus       @default(PENDING)

    expiresAt      DateTime
    createdAt      DateTime     @default(now())

    @@index([organizationId])
    @@map("invitation_link")
}

enum UpdateStatus {
    DRAFT
    PUBLISHED
    ARCHIVED
}

enum UpdateType {
    GENERAL
    FEATURE
    BUGFIX
}

model Update {
    id            String    @id
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

    title          String
    content        String
    status         UpdateStatus @default(DRAFT)
    type           UpdateType   @default(GENERAL)

    valid          Boolean   @default(false)
    validatedById  String?
    validatedBy    User?     @relation("validatedUpdates", fields: [validatedById], references: [id], onDelete: SetNull)
    validatedAt    DateTime?

    createdAt      DateTime  @default(now())

    @@index([organizationId])
    @@map("update")
}