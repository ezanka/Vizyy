generator client {
    provider = "prisma-client"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "postgresql"
}

model User {
    id            String    @id
    name          String
    email         String
    emailVerified Boolean   @default(false)
    image         String?
    company       String?
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt
    sessions      Session[]
    accounts      Account[]
    organizations Organization[] @relation("ownerOrganizations")

    members     Member[]
    invitations Invitation[]
    inviterInvitationLinks InvitationLink[] @relation("inviterInvitationLinks")
    joinerInvitationLinks   InvitationLink[] @relation("joinerInvitationLinks")

    updatesValidated Update[] @relation("validatedUpdates")
    updatesAuthored  Update[] @relation("authorUpdates")
    updatesUpdated  Update[] @relation("updaterUpdates")

    testsCreated Test[] @relation("createdByTests")
    testsUpdated Test[] @relation("updatedByTests")
    
    feedback      Feedback[]

    @@unique([email])
    @@map("user")
}

model Session {
    id        String   @id
    expiresAt DateTime
    token     String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    ipAddress String?
    userAgent String?
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    activeOrganizationId String?

    @@unique([token])
    @@index([userId])
    @@map("session")
}

model Account {
    id                    String    @id
    accountId             String
    providerId            String
    userId                String
    user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    password              String?
    createdAt             DateTime  @default(now())
    updatedAt             DateTime  @updatedAt

    @@index([userId])
    @@map("account")
}

model Verification {
    id         String   @id
    identifier String
    value      String
    expiresAt  DateTime
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@index([identifier])
    @@map("verification")
}

model Organization {
    id          String    @id
    name        String
    slug        String
    logo        String?
    createdAt   DateTime
    metadata    String?
    deadline    DateTime?
    progress    Int       @default(0)
    ownerId     String
    owner       User      @relation("ownerOrganizations", fields: [ownerId], references: [id], onDelete: Cascade)

    members     Member[]
    invitations Invitation[]
    invitationLinks InvitationLink[]
    updates     Update[]
    timelines   Timeline[]
    tests       Test[]

    @@unique([slug])
    @@map("organization")
}

enum MemberRole {
    MAKER
    CLIENT
}

model Member {
    id             String       @id
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    userId         String
    user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    role           MemberRole   @default(CLIENT)
    createdAt      DateTime

    @@unique([userId, organizationId])
    @@index([organizationId])
    @@index([userId])
    @@map("member")
}

enum InvitationStatus {
    PENDING
    ACCEPTED
    EXPIRED
}

model Invitation {
    id             String       @id
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    email          String
    role           MemberRole   @default(CLIENT)
    status         InvitationStatus       @default(PENDING)
    expiresAt      DateTime
    createdAt      DateTime     @default(now())
    inviterId      String
    user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

    @@index([organizationId])
    @@index([email])
    @@map("invitation")
}

model InvitationLink {
    id             String       @id
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    role           MemberRole   @default(CLIENT)
    link           String       @unique

    inviterId      String
    user           User         @relation("inviterInvitationLinks", fields: [inviterId], references: [id], onDelete: Cascade)

    joinerId      String?
    joiner        User?        @relation("joinerInvitationLinks", fields: [joinerId], references: [id], onDelete: SetNull)

    status         InvitationStatus       @default(PENDING)

    expiresAt      DateTime
    createdAt      DateTime     @default(now())

    @@index([organizationId])
    @@map("invitation_link")
}

enum UpdateStatus {
    IN_PROGRESS
    PENDING
    DONE
    BLOCKED
    DRAFT
}

enum UpdateType {
    FEATURE
    DESIGN
    DEPLOY
    BUGFIX
    OTHER
}

model Update {
    id            String    @id
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

    title          String
    content        String
    status         UpdateStatus @default(DRAFT)
    type           UpdateType   @default(FEATURE)
    needsValidation Boolean   @default(true)
    previewLink    String?
    timeSpent      Int?
    
    valid          Boolean   @default(false)
    validatedById  String?
    validatedBy    User?     @relation("validatedUpdates", fields: [validatedById], references: [id], onDelete: SetNull)
    validatedAt    DateTime?

    authorId      String
    author        User      @relation("authorUpdates", fields: [authorId], references: [id], onDelete: Cascade)

    updaterId    String?
    updater      User?     @relation("updaterUpdates", fields: [updaterId], references: [id], onDelete: SetNull)

    timeline       Timeline[]

    feedback      Feedback[]

    tests         Test[]

    createdAt      DateTime  @default(now())
    updatedAt      DateTime? 

    @@index([organizationId])
    @@map("update")
}

model Timeline {
    id        String   @id
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    name      String

    startDate DateTime
    endDate   DateTime

    updateId String?
    update   Update?  @relation(fields: [updateId], references: [id], onDelete: SetNull)

    createdAt DateTime @default(now())
    updatedAt DateTime? @updatedAt
}

model Feedback {
    id        String   @id
    updateId  String
    update    Update   @relation(fields: [updateId], references: [id], onDelete: Cascade)
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    content   String
    createdAt DateTime @default(now())
    updatedAt DateTime? @updatedAt
}

enum TestStatus {
    PASSED
    FAILED
    PENDING
}

enum TestType {
    UNIT
    INTEGRATION
    E2E
    OTHER
}

model Test {
    id        String   @id

    projectId String
    project   Organization @relation(fields: [projectId], references: [id], onDelete: Cascade)

    updateId  String
    update    Update   @relation(fields: [updateId], references: [id], onDelete: Cascade)

    type      TestType
    status    TestStatus
    details   String?


    createdById String
    createdBy   User?     @relation("createdByTests", fields: [createdById], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())

    updatedById String?
    updatedBy   User?     @relation("updatedByTests", fields: [updatedById], references: [id], onDelete: SetNull)
    updatedAt DateTime? @updatedAt
}